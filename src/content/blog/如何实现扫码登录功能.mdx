---
title: "如何实现扫码登录功能"
description: "这篇文章主要记录自己对于扫码登录功能实现的思考，因为之前面试的时候有被问到过"
pubDate: "10 06 2024"
categories:
  - tech
tags:
  - 业务思考
---

# 前言

原始的登录方式一般是采用账号+密码来操作的，或者是通过给用户邮箱发送验证码然后在客户端输入验证码来进行登录

上述两种方案以及等会要讲的扫码登录功能各有各的利弊

这篇文章主要讲一下对于扫码登录功能如何实现的一些思考

登录功能涉及的部分：PC端(浏览器/客户端)，手机端，服务端

# 扫码登录涉及的两个问题

1. 手机端如何完成身份认证？
2. PC端如何完成登录？

## 手机端如何完成身份认证？

如果我们使用账号密码的方式登录，PC端完成账户密码输入之后，服务端会返回一个token作为身份标识，从而登录之后的每一次请求都会携带这个标识

服务端处理请求的时候先校验token，通过则继续，不通过则失败

但是对于扫码登录，手机端如何完成身份认证呢？

PC端没法同步获取认证成功之后的凭据，必须用某种方式来让PC端获取认证的凭据

### 二维码？

当PC端点击登录按钮要跳转到扫码登录页面的时候，服务端应该生成一个二维码ID作为唯一标识，并且设置二维码过期时间以及当前状态(已扫码，未扫码，过期失效...)并存储起来(个人认为可以使用Redis进行暂时缓存)

然后PC端根据这个二维码ID生成一个对应的二维码展示在用户界面上

所以二维码应该是由PC端生成的而不是服务端

### app认证机制

这部分内容是在网上搜罗的，但是也是必须要了解的，基于APP的移动互联网认证机制

手机上的app当你第一次进入的时候需要用到账号和密码，但是后续即便你把后台进程清除了，下一次打开app的时候也不需要你重新登录

1. APP登录认证的时候除了账号密码，还有设备信息
2. 账号密码校验通过，服务端会把账号与设备进行一个绑定，进行持久化的保存，包含了账号ID，设备ID，设备类型等等
3. APP每次请求除了携带token key，还需要携带设备信息

<image src="/app认证机制.png"/>

### 手机扫码做了什么？

当手机扫码的时候，通过带有认证信息(token以及设备信息)以及二维码ID向服务端请求登录，服务端进行校验，完成认证过程，确认PC端登录

## PC端如何登录？

上述手机端已经完成了自己的所有工作，接下来就要交给PC端进入登录状态

当手机端上扫码成功点击确认登录之后，服务端应该给PC端一个相应的token

那么问题来了，PC端如何获取这个token呢？

首先PC端通过获取二维码的状态来进行对应的操作

- 二维码未扫描：不进行操作
- 二维码已失效：提示用户刷新二维码
- 二维码已扫描：从服务端获取PC token

如何获取二维码的状态呢？一般可以通过轮询，长轮询，websocket这三种方式

轮询：轮询方式是指客户端会每隔一段时间就主动给服务端发送一次二维码状态的查询请求(这个请求会携带二维码ID)

长轮询：指客户端主动给服务端发送二维码状态的查询请求，服务端会按情况对请求进行阻塞，直至二维码信息更新或超时。当客户端接收到返回结果后，若二维码仍未被扫描，则会继续发送查询请求，直至状态变化（已失效或已成功）

websocket：指客户端通过websocket协议与服务端建立连接，当二维码状态发生变化时，服务端主动推送给客户端，客户端收到消息后，根据二维码状态进行相应的操作

# 登录流程

登录的流程大致如下：

1. 用户在浏览器(PC端)点击登录按钮，访问扫码登录的页面，PC端向服务端请求一个二维码ID
2. 服务端生成相应的二维码ID，并且设置二维码过期时间，以及当前状态等的一些信息
3. PC端根据二维码ID生成对应二维码
4. 用户手机进行扫码，获取到二维码ID
5. 手机端将手机端token以及二维码ID发送给服务端，确认登录
6. 服务端校验手机端token，根据手机端token以及二维码ID生成PC端token
7. PC端通过轮询方式请求服务端，通过二维码ID获取二维码状态，如果已成功，返回PC token，登录成功

流程图如下：(图片来源于三分恶)

<image src="/登录流程.png"/>

# 总结

大部分内容其实和现有的成熟方案没有什么区别，只是自己梳理一下整个功能的流程方便自己学习